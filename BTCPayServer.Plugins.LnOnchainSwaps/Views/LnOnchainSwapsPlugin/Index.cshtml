@using BTCPayServer.Abstractions.Extensions
@using BTCPayServer.Plugins.LnOnchainSwaps.Views
@using BTCPayServer.Client
@using BTCPayServer.Plugins.LnOnchainSwaps.Models
@using BTCPayServer.Services
@using BTCPayServer.Abstractions.Services

@inject DisplayFormatter DisplayFormatter
@inject Safe Safe

@model LnOnchainSwapsViewModel
@{
    ViewData.SetActivePage(PluginNavPages.Index, "Lightning/Onchain Swaps plugin");
}

<table><tr>
    <td>
        <img src="/Resources/img/LnOnchainSwaps.webp" />
    </td>
    <td width="20"></td>
    <td>
        <h2>@ViewData["Title"]</h2>
        <br />
        <p>
            Effortlessly perform Boltz swaps to balance your internal BTC onchain and Lightning treasury. You can also easily swap to external wallets.<br />
            Please read our documentation <a href="https://github.com/LnOnchainSwaps/btcpay-plugin/blob/master/BTCPayServer.Plugins.LnOnchainSwaps/README.md" target="_blank">here</a>.
        </p>
    </td>
</tr></table>
<br />

<partial name="_StatusMessage" />
@Html.AntiForgeryToken()
<script>
    var antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;
</script>

@if (Model.IsPayoutCreated)
{
    <br />
    <div class="card border-success mb-4">
    <div class="card-body">
        <div class="d-flex align-items-start gap-3">
            <div class="text-success" style="font-size: 2.5rem; line-height: 1;">
                <vc:icon symbol="checkmark" />
            </div>
            <div class="flex-grow-1">
                <h5 class="card-title text-success mb-3">
                    <span class="badge bg-success me-2">Success</span>
                    Payout Created Successfully!
                </h5>
                <p class="card-text mb-2">Your payout has been created.</p>
                <p class="card-text mb-2">If you have set an automatic payout processor, the payment will be sent automatically to Boltz.</p>
                <p class="card-text mb-2">
                    Otherwise, <a href="/stores/@Model.StoreId/payouts?payoutState=AwaitingPayment" class="fw-bold text-decoration-underline">click here</a> to validate the payout.
                </p>
                <p class="card-text text-muted mb-0">
                    <small>If an issue arises, please contact hello@LnOnchainSwaps.com.</small>
                </p>
            </div>
        </div>
    </div>
</div>
}

<div permission="@Policies.CanCreateNonApprovedPullPayments,@Policies.CanManagePayouts">

    <br />
    @if (!Model.WalletConfig.OnChainAvailable)
    {
        <br />
        <p>At least the Onchain wallet mut be configured wallet for this store</p>
    }

<h4>Boltz Rescue file</h4>
<table class="table table-sm mt-0 mx-0">
    <tr>
        <td>
            <p>In case of a swap fails, download this rescue file and upload it to the <a href="https://boltz.exchange/rescue/external" target="_blank">Boltz Rescue External Swap page</a>.</p>
        </td><td width="20"></td>
        <td><button class="btn btn-primary" onclick="onDownloadRescue()">Download Boltz Rescue file</button></td>
    </tr>
</table>
   
<script type="text/javascript">
    function onDownloadRescue(){
        const form = document.createElement('form');
        form.method = 'GET';
        form.action = 'LnOnchainSwaps/DownloadRefundJson';

        const inputFg = document.createElement('input');
        inputFg.type = 'hidden';
        inputFg.name = '__RequestVerificationToken';
        inputFg.value = antiForgeryToken;
        form.appendChild(inputFg);

        document.body.appendChild(form);
        form.submit();
    }
</script>

<br /><hr />
<h4>Operations</h4>
<br />

    <table class="table table-sm mt-0 mx-0">
        <tr>
            <td>
                <h5>On Chain</h5>
                <p><b>Balance</b>: @Model.WalletConfig.OnChainBalance BTC  ~ @DisplayFormatter.Currency(Model.WalletConfig.OnChainFiatBalance, Model.WalletConfig.FiatCurrency)</p>
                @if (Model.WalletConfig.OnChainBalance == 0)
                {
                    <p>No bitcoins available for swap</p>
                }
            </td><td width="20"></td>
            <td>
                <h5>Lightning</h5>
                @if (Model.WalletConfig.OffChainEnabled)
                {
                    <p><b>Balance</b>: @Model.WalletConfig.OffChainBalance BTC  ~ @DisplayFormatter.Currency(Model.WalletConfig.OffChainFiatBalance, Model.WalletConfig.FiatCurrency)</p>
                }
                else
                {
                    <p>Lightning not configured</p>
                }
                @if (Model.WalletConfig.OffChainBalance == 0)
                {
                    <p>No bitcoins available for swap</p>
                }
            </td>
        </tr>
    </table>

    <table class="table table-sm mt-0 mx-0"><tr>
        <td><b>Swap from :</b></td>
        <td width="10"></td>
        <td>
            <input value="FromOnchain" name="chkFromSwap" type="radio" checked="checked" class="form-check-input mt-0 me-2" onchange="showRows()" />&nbsp; On Chain BTCPay Wallet
        </td>

        @if (Model.WalletConfig.OffChainAvailable)
        {
            <td width="10"></td>
            <td>
                <input value="FromLightning" name="chkFromSwap" type="radio" class="form-check-input mt-0 me-2" onchange="showRows()" />&nbsp; Lightning BTCPay Wallet
            </td>
        }
        </tr>
        @if (Model.WalletConfig.OffChainAvailable)
        {
            <tr id="rowSwapToOnchain" style="display:none">
                <td><b>Swap to :</b></td>
                <td width="10"></td>
                <td>
                    <input id="chkToOnchainInternal" name="chkToSwapOnChain" value="" type="radio" checked="checked" class="form-check-input mt-0 me-2" />&nbsp; On Chain BTCPay Wallet
                </td>
                <td width="10"></td>
                <td>
                    @Html.RadioButton("chkToSwapOnChain", "external", false, new { @class = "form-check-input mt-0 me-2", id = "chkToOnchainExternal" })
                    &nbsp;External On Chain Wallet :&nbsp;
                    <input id="txtToOnchainExternal" type="text" class="form-control form-control-sm" placeholder="Paste an external btc address" />
                </td>
            </tr>
        }
        <tr id="rowSwapToLightning">
            <td><b>Swap to :</b></td>
            <td width="10"></td>
            @if (Model.WalletConfig.OffChainAvailable)
            {
                <td>
                    <input id="chkToLightningInternal" name="chkToSwapLightning" value="" type="radio" checked="checked" class="form-check-input mt-0 me-2" />&nbsp; Lightning BTCPay Wallet
                </td>
                <td width="10"></td>
            }
            <td>
                @Html.RadioButton("chkToSwapLightning", "external", !Model.WalletConfig.OffChainAvailable, new { @class = "form-check-input mt-0 me-2", id = "chkLightningExternal" })
                &nbsp;External Lightning Wallet : &nbsp;
                <input id="txtLightningExternal" type="text" class="form-control form-control-sm" placeholder="Paste a Lightning invoice" onchange="setSwapValues()" />
            </td>
        </tr>
    </table>
    <br />
    <table class="table table-sm mt-0 mx-0">
        <tr>
            <td>
                Percent to swap:&nbsp;
                <input id="percentToSend" type="number" min="0" max="99" value="95" oninput="setSwapValues()" />
                <br />
            </td>
            <td width="25"></td>
            <td>
                <label id="lblToSendBTC">@(Model.WalletConfig.OnChainBalance * (decimal)0.95)</label>&nbsp; BTC - &nbsp;
                <label id="lblToSendFiat">@((int)(Model.WalletConfig.OnChainFiatBalance * (decimal)0.95))</label>&nbsp; @Model.WalletConfig.FiatCurrency
            </td>
            <td width="25"></td>
            <td><button id="btSend" class="btn btn-primary" onclick="onSwap()">Do Swap</button></td>
        </tr>
    </table>
    <br />
        <i><small>Please check that there is no previous pending payout in BTCPay before placing a swap.<br />
        </small></i>
    <br />
   
    <script type="text/javascript">
        const OnChainBalance = @Model.WalletConfig.OnChainBalance;
        const OffChainBalance = @Model.WalletConfig.OffChainBalance;

        const lblToSendBTC = document.getElementById('lblToSendBTC');
        const lblToSendFiat = document.getElementById('lblToSendFiat');
        const percentToSend = document.getElementById('percentToSend');

        function setSwapValues() {
            const percent = parseFloat(percentToSend.value);
            if (percent > 99) {
                alert('You must keep some sats for the transaction fees... Please reduce the amount');
                percentToSend.value = 99;
                return;
            }
            const isOnChain =  $("input[name='chkFromSwap']:checked").val() === "FromOnchain";
            const fiatBalance = isOnChain ? @Model.WalletConfig.OnChainFiatBalance : @Model.WalletConfig.OffChainFiatBalance;
            const btcBalance = isOnChain ? OnChainBalance : OffChainBalance;

            lblToSendBTC.textContent = ((percent * btcBalance) / 100).toFixed(8);
            lblToSendFiat.textContent = Math.round((percent * fiatBalance) / 100);
        }

        function showRows() {
            const isOnChain =  $("input[name='chkFromSwap']:checked").val() === "FromOnchain";

            if (isOnChain) {
                document.getElementById('rowSwapToOnchain').style.display = 'none';
                document.getElementById('rowSwapToLightning').style.display = 'table-row';
            } else {
                document.getElementById('rowSwapToOnchain').style.display = 'table-row';
                document.getElementById('rowSwapToLightning').style.display = 'none';
            }
            setSwapValues();
        }

        function onSwap() {
            const percent = parseFloat(percentToSend.value) || 0;
            if (percent == 100) {
                alert('You must keep some sats for the transaction fees... Please reduce the amount');
                return;
            }

            const isOnChain =  $("input[name='chkFromSwap']:checked").val() === "FromOnchain";
            if (!isOnChain) {
                alert('Lightning -> Onchain swaps are not yet enabled. They will be available in a future update.');
                return;
            }

            const isInternal = isOnChain ? $('#chkToLightningInternal').is(':checked') : $('#chkToOnchainInternal').is(':checked');
            if (!isInternal) {
                alert('Onchain Swaps to external Lightning wallets are not yet enabled. They will be available in a future update.');
                return;
            }

            $('#btSend').hide();

            const externalVal = isOnChain ? $('#txtLightningExternal').val() : $('#txtToOnchainExternal').val();
            if (externalVal) {
                const bFlag = isOnChain ? isValidLightningInvoice(externalVal) : isValidBitcoinAddress(externalVal);
                if (!bFlag) {
                    alert(isOnChain ? 'The Lightning invoice is not valid' : 'The Bitcoin address is not valid');
                    $('#btSend').show();
                    return;
                }
            } else if (!isInternal) {
                alert('You must select an internal wallet or provide an external address/invoice');
                $('#btSend').show();
                return;
            }

            $('#SwapType').val(isOnChain ? '@BoltzSwap.SwapTypeOnChainToLn' : '@BoltzSwap.SwapTypeLnToOnChain');
            $('#BtcAmount').val(lblToSendBTC.textContent);
            $('#IsInternal').val(isInternal);
            $('#ExternalAddressOrInvoice').val(externalVal);
            $('#frmSwap')[0].submit();
        }

        function isValidBitcoinAddress(address) {
            const base58Regex = /^[13][a-km-zA-HJ-NP-Z1-9]{25,34}$/;
            const bech32Regex = /^(bc1)[0-9a-z]{25,39}$/;
            return base58Regex.test(address) || bech32Regex.test(address);
        }

        function isValidLightningInvoice(invoice) {
            const lightningRegex = /^(ln(bc|tb|bcrt))[0-9a-z]+$/;
            return lightningRegex.test(invoice) && invoice.length >= 20 && invoice.length <= 2000;
        }
    </script>
    <form method="post" autocomplete="off" action="LnOnchainSwaps/CreateSwap" id="frmSwap">
        @Html.AntiForgeryToken()
        <input type="hidden" name="SwapType" id="SwapType" />
        <input type="hidden" name="BtcAmount" id="BtcAmount" />
        <input type="hidden" name="IsInternal" id="IsInternal" />
        <input type="hidden" name="ExternalAddressOrInvoice" id="ExternalAddressOrInvoice" />
    </form>

    <br /><br />
    <h4>Swaps</h4>
    <br />
    @if (Model.Swaps.Any())
    {
        var page = Context.Request.Query["page"].Count > 0 ? int.Parse(Context.Request.Query["page"]) : 1;
        var pageSize = 20;
        var totalItems = Model.Swaps.Count();
        var totalPages = (int)Math.Ceiling(totalItems / (double)pageSize);
        var pagedTransactions = Model.Swaps
            .Skip((page - 1) * pageSize)
            .Take(pageSize)
            .ToList();
        <link rel="stylesheet" type="text/css" href="/Resources/css/pre-style.css">

        <div class="table-responsive">
            <table class="table table-hover mass-action">
                <thead mass-action-head>
                    <tr>
                        <th>Swap ID</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Original Amount</th>
                        <th>Swap Amount</th>
                        <th>Invoice</th>
                        <th>Pull Payment</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var swap in Model.Swaps)
                    {
                        var detailsId = $"swapDetails_{swap.SwapId}";
                        <tr class="mass-action-row item">
                            <td class="text-break align-middle invoiceId-col">
                                <div class="badge badge-settled">@swap.SwapId</div>
                            </td>
                            <td align="center">
                                <div class="badge badge-expired" id="status-@swap.SwapId">@swap.Status</div><br />
                                <a href="#" onclick="GetSwapStatus('@swap.SwapId');return false;">
                                    <vc:icon symbol="actions-refresh" class="icon-refresh" />
                                </a>
                            </td>
                            <td>@swap.DateT</td>
                            <td><div class="badge badge-expired">@swap.Type</div></td>
                            <td align="right">@swap.OriginalAmount</td>
                            <td align="right">@swap.ExpectedAmount</td>
                            <td class="text-break align-middle invoiceId-col">
                                <a asp-controller="UIInvoice" asp-action="Invoice" asp-route-invoiceId="@swap.BTCPayInvoiceId" class="text-break">@swap.BTCPayInvoiceId</a>
                            </td>
                            <td class="text-break align-middle invoiceId-col">
                                <a asp-controller="UIPullPayment" asp-action="ViewPullPayment" asp-route-pullPaymentId="@swap.BTCPayPullPaymentId" class="text-break">@swap.BTCPayPullPaymentId</a>
                            </td>
                            <td class="align-middle text-end">
                                <div class="d-inline-flex align-items-center gap-2">
                                    <button class="accordion-button collapsed only-for-js ms-0 d-inline-block" type="button" data-bs-toggle="collapse" data-bs-target="#@detailsId" aria-expanded="false" aria-controls="@detailsId">
                                        <vc:icon symbol="caret-down" />
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr id="@detailsId" class="invoice-details-row collapse">
                        <td colspan="9" class="border-top-0">
                            <b>Initial Json:</b><br />
                            <pre>@Safe.Raw(@swap.HighlightJson)</pre>
                            <br />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <script>
            function GetSwapStatus(swapId) {
                $('#status-' + swapId).hide();
                $.ajax({
                    url: 'LnOnchainSwaps/GetSwapStatus',
                    type: 'GET',
                    data: { swapId: swapId },
                    success: function (data) {
                        if (data) {
                            $('#status-' + swapId).text(data);
                        } else {
                            console.log('No status returned for swap ID:', swapId);
                        }
                        $('#status-' + swapId).show();
                    },
                    error: function (dataError) {
                        console.log('Error fetching swap status:', dataError);
                        $('#status-' + swapId).show();
                    }
                });
            }
        </script>
    }
    else
    {
        <p>No swaps found.</p>
    }
</div>
