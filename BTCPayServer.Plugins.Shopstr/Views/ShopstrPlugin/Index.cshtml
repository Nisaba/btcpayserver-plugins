@using BTCPayServer.Abstractions.Extensions
@using BTCPayServer.Plugins.Shopstr.Models
@using BTCPayServer.Plugins.Shopstr.Models.Shopstr
@using BTCPayServer.Plugins.Shopstr.Views
@using System.ComponentModel

@model ShopstrViewModel
@{
    ViewData.SetActivePage(PluginNavPages.Index, "Shopstr plugin");
    bool bNostr;
    bool bApp;
}

<table>
    <tr>
        <td>
            <a href="https://shopstr.market/">
                <img src="/Resources/img/Shopstr.webp" />
            </a>
        </td>
        <td width="20" />
        <td>
            <p>
                Shopstr plugin<br />
                Please read our documentation <a href="https://github.com/Nisaba/btcpayserver-plugins/blob/master/BTCPayServer.Plugins.Shopstr/README.md" target="_blank">here</a>.
            </p>
        </td>
    </tr>
</table>
<br />

<!-- <partial name="_StatusMessage" /> -->

@if (Model.Nip5Settings == null || !Model.Nip5Settings.IsConfigured)
{
    <div class="alert alert-warning d-flex align-items-center" role="alert">
        <span class="me-2"><vc:icon symbol="warning" /></span>
        Your Nostr plugin is not configured yet.
        <a href="/stores/@Model.storeId/plugins/nip5" class="alert-link ms-2">Configure now</a>
    </div>
    bNostr = false;
}
else
{
    <div class="card mb-3">
        <div class="card-header">
            <strong>Nostr Configuration</strong>
        </div>
        <div class="card-body">
            <div class="mb-2">
                <span class="badge bg-success me-2">Pubkey</span>
                <span class="badge badge-expired">@Model.Nip5Settings.PubKey</span>
            </div>
            <div>
                <span class="badge bg-info me-2">Relays</span>
                <span>
                    @foreach (var rel in Model.Nip5Settings.Relays)
                    {
                        <span class="badge badge-expired">
                            @rel
                        </span>
                    }
                </span>
            </div>
        </div>
    </div>
    bNostr = true;
}
@if (Model.StoreApps.Count == 0)
{
    <div class="alert alert-info d-flex align-items-center" role="alert">
        <span class="me-2"><vc:icon symbol="warning"/></span>
        You do not have any Shop apps in your BTCPay store yet.
        <a href="/stores/@Model.storeId/apps/create/PointOfSale" class="alert-link ms-2">Create an app</a>
    </div>
    bApp = false;
}
else
{
    <div class="alert d-flex align-items-center" role="alert">
        <span class="me-2"><vc:icon symbol="warning" /></span>
        @Model.StoreApps.Count Shop app(s) ready to be synchronized in this store.
    </div>
    bApp = true;
}
@if (bNostr && bApp)
{
    var isTor = Context.Request.Host.Host.Contains(".onion");
    var shopstrMarketplaceUrl = isTor
        ? "http://sva5te372puuuyhnp4mrspewm76x2jqnzgctdfde474owrdonu4xyoyd.onion/"
        : "https://shopstr.market/marketplace";
    var shopstrMyListingsUrl = isTor
        ? "http://sva5te372puuuyhnp4mrspewm76x2jqnzgctdfde474owrdonu4xyoyd.onion/my-listings"
        : "https://shopstr.market/my-listings";

    <div class="row mb-4">
        <div class="col-md-6 pe-md-2">
            <a href="@shopstrMarketplaceUrl" target="_blank" class="card text-decoration-none h-100">
                <div class="card-body">
                    <h5 class="card-title">Browse Latest Listings</h5>
                    <p class="card-text text-muted mb-0">Explore the most recent product listings on Shopstr Marketplace.</p>
                </div>
            </a>
        </div>
        <div class="col-md-6 ps-md-2">
            <a href="@shopstrMyListingsUrl" target="_blank" class="card text-decoration-none h-100">
                <div class="card-body">
                    <h5 class="card-title">My Listings</h5>
                    <p class="card-text text-muted mb-0">Manage and view your published listings on the Shopstr Marketplace.</p>
                </div>
            </a>
        </div>
    </div>

    <br/>

    <div class="table-responsive">
        <table class="table table-hover mass-action">
            <thead>
                <tr>
                    <th>App Name</th>
                    <th>Items</th>
                    <th>Active Items</th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var app in Model.StoreApps)
                {
                    var detailsId = $"appDetails_{app.Id}";
                    <tr>
                        <td><div class="badge badge-settled">@app.Name</div></td>
                        <td><div class="badge badge-expired">@app.ShopItems.Count()</div></td>
                        <td><div class="badge badge-expired">@app.ShopItems.Count(a => !(a.Disabled || a.Inventory == 0))</div></td>
                        <td align="center">
                            <button id="BtPublish@{@app.Id}" class="btn btn-secondary" onclick="DoPublish('@app.Id')">Publish on Nostr</button>
                            <img id="WaitPublish@{@app.Id}" src="/Resources/img/waiting.webp" style="display:none" />
                        </td>
                        <td align="center">
                            <button id="BtUnpublish@{@app.Id}" class="btn btn-secondary" onclick="DoUnpublish('@app.Id')">Unpublish</button>
                            <img id="WaitUnpublish@{@app.Id}" src="/Resources/img/waiting.webp" style="display:none" />
                        </td>
                        <td class="align-middle text-end">
                            <div class="d-inline-flex align-items-center gap-2">
                                <span class="text-muted small me-1">Default settings</span>
                                <button class="accordion-button collapsed only-for-js ms-0 d-inline-block" type="button" data-bs-toggle="collapse" data-bs-target="#@detailsId" aria-expanded="false" aria-controls="@detailsId" aria-label="Toggle default settings">
                                    <vc:icon symbol="caret-down" />
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr id="@detailsId" class="invoice-details-row collapse">
                        <td colspan="6" class="border-top-0">
                            <div class="p-3">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="selAppLocation@{@app.Id}" class="form-label">Location</label>
                                        <select id="selAppLocation@{@app.Id}" class="form-select">
                                            <option value="" selected="@(string.IsNullOrEmpty(app.Location) ? "selected" : null)">Select a location</option>
                                            @foreach (var group in ShopstrSettings.AvailableLocations)
                                            {
                                                <optgroup label="@group.Key">
                                                    @foreach (var location in group.Value)
                                                    {
                                                        <option value="@location" selected="@(app.Location == location ? "selected" : null)">@location</option>
                                                    }
                                                </optgroup>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="chkFlashSales@{@app.Id}" class="form-label">Flash Sales</label>
                                        <div class="form-check mt-2">
                                            <input id="chkFlashSales@{@app.Id}" class="form-check-input" type="checkbox" @(app.FlashSales ? "checked" : "") />
                                            <label class="form-check-label" for="chkFlashSales@{@app.Id}">Enabled</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="selCondition@{@app.Id}" class="form-label">Condition</label>
                                        <select id="selCondition@{@app.Id}" class="form-select">
                                            @foreach (var condition in Enum.GetValues(typeof(ConditionEnum)))
                                            {
                                                var field = typeof(ConditionEnum).GetField(condition.ToString());
                                                var descAttr = (DescriptionAttribute)field.GetCustomAttributes(typeof(DescriptionAttribute), false).FirstOrDefault();
                                                var displayText = descAttr?.Description ?? condition.ToString();
                                                var isSelected = (ConditionEnum)condition == app.Condition;
                                                <option value="@condition" selected="@(isSelected ? "selected" : null)">@displayText</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="dtValidDateT@{@app.Id}" class="form-label">Valid Date</label>
                                        <input id="dtValidDateT@{@app.Id}" type="date" value="@(app.ValidDateT?.ToString("yyyy-MM-dd"))" class="form-control" />
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <label for="txtRestrictions@{@app.Id}" class="form-label">Restrictions</label>
                                        <input id="txtRestrictions@{@app.Id}" type="text" value="@app.Restrictions" class="form-control" placeholder="US shipping only, signature required, no P.O. box delivery, etc."/>
                                    </div>
                                </div>

                                <div class="row mt-3">
                                    <div class="col-12 d-flex justify-content-end gap-2">
                                        <button id="BtSave@{@app.Id}" class="btn btn-primary" onclick="BtSaveApp('@app.Id')">Save</button>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>



    @Html.AntiForgeryToken()

    <script type="text/javascript" >
        var antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;
    
    function BtSaveApp(appId) {
        var location = $('#selAppLocation' + appId).val();
        var flashSales = $('#chkFlashSales' + appId).is(':checked');
        var condition = $('#selCondition' + appId).val();

        var dtEl = document.getElementById('dtValidDateT' + appId);
        var validDateT = '';
        if (dtEl) {
            validDateT = dtEl.value || dtEl.getAttribute('value') || '';
        }
        var day = '';
        var month = '';
        var year = '';
        if (validDateT) {
            var datePart = validDateT.split('T')[0];
            var parts = datePart.split('-');
            if (parts.length === 3) {
                year = parseInt(parts[0], 10) || '';
                month = parseInt(parts[1], 10) || '';
                day = parseInt(parts[2], 10) || '';
            }
        }

        var restrictions = $('#txtRestrictions' + appId).val();

        $('#BtSave' + appId).hide();
        $.ajax({
            url: 'Shopstr/SaveSettings',
            type: 'POST',
            data: { appId: appId, location: location, flashSales: flashSales, condition: condition, day: day, month: month, year: year, restrictions: restrictions },
            headers: {
                'RequestVerificationToken': antiForgeryToken
            },
            success: function(result) {
                alert("App settings saved");
                $('#BtSave' + appId).show();
            },
            error: function (xhr, status, error) {
                alert("Error: " + error + " - " + xhr.responseText);
                $('#BtSave' + appId).show();
            }
        });
    }

    function DoPublish(appId) {
        if (confirm("Are you sure you want to publish ? This will add and/or update your BTCPay products to Shopstr marketplace... ") == false) {
            return;
        }
        $('#BtPublish' + appId).hide();
        $('#WaitPublish' + appId).show();
        $.ajax({
            url: 'Shopstr/PublishToShopstr',
            type: 'POST',
            data: { appId: appId },
            headers: {
                'RequestVerificationToken': antiForgeryToken
            },
            success: function(result) {
                alert("Publish to Shopstr OK");
                $('#WaitPublish' + appId).hide();
                $('#BtPublish' + appId).show();
            },
            error: function (xhr, status, error) {
                alert("Error: " + error + " - " + xhr.responseText);
                $('#WaitPublish' + appId).hide();
                $('#BtPublish' + appId).show();
            }
        });
    }

        function DoUnpublish(appId) {
            if (confirm("Are you sure you want to unpublish ? This will remove your BTCPay products from Shopstr marketplace... ") == false) {
                return;
            }
            $('#BtUnpublish' + appId).hide();
            $('#WaitUnpublish' + appId).show();
            $.ajax({
                url: 'Shopstr/UnPublishFromShopstr',
                type: 'POST',
                data: { appId: appId },
                headers: {
                    'RequestVerificationToken': antiForgeryToken
                },
                success: function(result) {
                    alert("Unpublish from Shopstr OK");
                    $('#WaitUnpublish' + appId).hide();
                    $('#BtUnpublish' + appId).show();
                },
                error: function (xhr, status, error) {
                    alert("Error: " + error + " - " + xhr.responseText);
                    $('#WaitUnpublish' + appId).hide();
                    $('#BtUnpublish' + appId).show();
                }
            });
        }
</script>
}