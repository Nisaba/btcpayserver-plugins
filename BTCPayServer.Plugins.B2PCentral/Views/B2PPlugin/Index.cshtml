@using BTCPayServer.Abstractions.Extensions
@using BTCPayServer.Abstractions.Services
@using BTCPayServer.Services
@using BTCPayServer.Client
@using BTCPayServer.Plugins.B2PCentral.Views
@using BTCPayServer.Plugins.B2PCentral.Models
@using BTCPayServer.Plugins.B2PCentral.Models.P2P
@using BTCPayServer.Plugins.B2PCentral.Models.Swaps
@using System.Text.Json

@inject BTCPayServer.Plugins.B2PCentral.Services.B2PCentralPluginService B2PCentralPluginService
@inject DisplayFormatter DisplayFormatter

@model B2PViewModel 
@functions {
    string GetCategoryIcon(CryptoCategory category) => category switch
    {
        CryptoCategory.Altcoin => "🪙",
        CryptoCategory.StablecoinUSD => "💵",
        CryptoCategory.StablecoinEUR => "💶",
        _ => "💰"
    };

    string GetCryptoIcon(string cryptoCode) => cryptoCode switch
    {
        "BTC" => "₿",
        "BCH" => "₿",
        "L-BTC" => "₿",
        "ETH" => "Ξ",
        "XMR" => "ɱ",
        "LTC" => "Ł",
        "DOGE" => "Ð",
        "TRX" => "Ⓣ",
        _ when cryptoCode.StartsWith("USDT") => "🟢",
        _ when cryptoCode.StartsWith("USDC") => "🔵",
        _ when cryptoCode.StartsWith("EUR") || cryptoCode.StartsWith("DEURO") => "🟡",
        _ => "◆"
    };
}
@{
    ViewData.SetActivePage(PluginNavPages.Index, "B2P Central plugin");
    Html.AntiForgeryToken();
    StoreWalletConfig walletConfig = null;
}
<table><tr>
        <td>
            <a href="https://www.b2p-central.com" target="b2p">
                <img src="/Resources/img/B2Plogo.jpg" />
            </a>
        </td>
        <td width="20" />
        <td>
            <h2>@ViewData["Title"]</h2>
            <br />
            <p>
                Get P2P bitcoin buy offers from <a href="https://www.b2p-central.com" target="b2p">B2P Central</a>, according to your onchain and lightning wallets balances and the store's default currency.<br />
                You can also perform onchain swaps to a variety of altcoins and stablecoins supported by B2P Central.<br />
             </p>
        </td>
</tr></table>
<br />

<partial name="_StatusMessage" />
@if (Model.IsPayoutCreated)
{
    <br />
    <div>
        <strong>Success!</strong> Your payout has been created.<br />
        If you have set an automatic payout processor, the payment will be sent automatically to the Swap provider.<br />
        Otherwise, <a href="/stores/@Model.Settings.StoreId/payouts?payoutState=AwaitingPayment">click here</a> to validate the payout.<br />
    </div>
}
<div permission="@Policies.CanModifyStoreSettings">
    <br />
    <h4>Configuration</h4>
    <p>
       First, you need to get a B2P Central API key <a href="https://getapi.b2p-central.com" target="b2pApi">here</a>.
    </p>
    <form method="post" autocomplete="off">
        <input asp-for="Settings.ProvidersString" type="hidden"/>
        <input asp-for="Settings.StoreId" type="hidden" />
        <table class="table table-sm mt-0 mx-0">
            <tr>
                <td width="100">
                    <label asp-for="Settings.ApiKey" class="form-label"></label>
                </td>
                <td width="400" class="border-0 ps-0 align-middle">
                    <input asp-for="Settings.ApiKey" data-fill="port" class="form-control" />
                    <span asp-validation-for="Settings.ApiKey" class="text-danger"></span>
                </td>
                <td width="20" />
                <td>
                    <button id="SaveButton" type="submit" class="btn btn-primary" value="Save" name="Command">Save</button>
                </td>
                @if (!string.IsNullOrEmpty(Model.Settings.ApiKey))
                {
                    <td>
                        <button class="btn btn-secondary mt-2" value="Test" name="Command">Test</button>
                    </td>
                }
            </tr>
        </table>
    </form>
</div>

<div>
    <br />
    @if (string.IsNullOrEmpty(Model.Settings.ApiKey))
    {
        <p>
            <i>B2P settings not set for this store...</i>
        </p>
    } else
    {
        walletConfig = await B2PCentralPluginService.GetBalances(Model.Settings.StoreId, $"{Context.Request.Scheme}://{Context.Request.Host}");

        <nav id="SectionNav">
            <div class="nav">
                <a id="SectionNav-1" class="nav-link active" href="#SectionNav" onclick="B2PCore.switchTab(1)"><vc:icon symbol="wallet-wallet" /> Sell (On Chain)</a>
                <a id="SectionNav-2" class="nav-link" href="#SectionNav" onclick="B2PCore.switchTab(2)"><vc:icon symbol="lightning" /> Sell (Lightning)</a>
                <a id="SectionNav-3" class="nav-link" href="#SectionNav" onclick="B2PCore.switchTab(3)"><vc:icon symbol="actions-refresh" /> Swaps (On Chain)</a>
                <a id="SectionNav-4" class="nav-link" href="#SectionNav" onclick="B2PCore.switchTab(4)"><vc:icon symbol="actions-refresh" /> Swaps list</a>
            </div>
        </nav>

        <div permission="@Policies.CanViewStoreSettings" id="tabOnChain">
            <h4>Sell (On Chain)</h4>
            @if (walletConfig.OnChainEnabled)
            {
                <p><b>Balance</b>: @walletConfig.OnChainBalance BTC  ~ @DisplayFormatter.Currency(walletConfig.OnChainFiatBalance, walletConfig.FiatCurrency)</p>
            }
            else
            {
                <p>On Chain wallet not configured</p>
            }

            @if (walletConfig.OnChainBalance == 0) {
                <p>No bitcoins available for sale</p>
            } else {

                <script type="text/javascript">
                    const onChainFiatBalance = @walletConfig.OnChainFiatBalance.ToString(System.Globalization.CultureInfo.InvariantCulture);
                    document.addEventListener('DOMContentLoaded', () => {
                        document.getElementById('percentOnChain').addEventListener('input', updateOnChainSale);
                    });

                    function updateOnChainSale() {
                        const percent = parseFloat(document.getElementById('percentOnChain').value) || 0;
                        const amount = parseInt((percent * onChainFiatBalance) / 100);
                        document.getElementById('lblOnChainSale').textContent = amount;
                    }

                    function OnChainSearchClick() {
                        var tbl = [];
                        if (document.querySelector('#chkHodl').checked) tbl.push(@((short)ProvidersEnum.HodlHodl));
                        if (document.querySelector('#chkNoo').checked) tbl.push(@((short)ProvidersEnum.NoOnes));
                        if (document.querySelector('#chkLocalSw').checked) tbl.push(@((short)ProvidersEnum.LocalCoinSwap));
                        if (document.querySelector('#chkPeach').checked) tbl.push(@((short)ProvidersEnum.Peach));
                        if (document.querySelector('#chkBisqV1').checked) tbl.push(@((short)ProvidersEnum.BisqV1));
                        if (tbl.length == 0) return;

                        const data = {
                            Rate: @walletConfig.Rate, ApiKey: '@Model.Settings.ApiKey', CurrencyCode: '@walletConfig.FiatCurrency',
                            Amount: document.getElementById('lblOnChainSale').textContent, Providers: tbl
                        };
                        B2PCore.getPartial(data, "#container-B2pOnChain", "#btOnChainSearch", "GetPartialB2PResult");
                    }
                </script>

                <b>Select providers:</b><br/>
                <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; min-width: 150px;">
                        <input id="chkHodl" type="checkbox" class="form-check-input me-2" checked />
                        <img src="/Resources/img/HodlHodl.webp" style="width: 28px; height: 28px; margin-right: 8px;"/>
                        <label for="chkHodl" class="form-check-label" style="cursor: pointer;">HodlHodl</label>
                    </div>
                    <div style="display: flex; align-items: center; min-width: 150px;">
                        <input id="chkNoo" type="checkbox" class="form-check-input me-2" checked />
                        <img src="/Resources/img/NoOnes.webp" style="width: 28px; height: 28px; margin-right: 8px;"/>
                        <label for="chkNoo" class="form-check-label" style="cursor: pointer;">NoOnes</label>
                    </div>
                    <div style="display: flex; align-items: center; min-width: 150px;">
                        <input id="chkLocalSw" type="checkbox" class="form-check-input me-2" checked />
                        <img src="/Resources/img/LocalCoinSwap.webp" style="width: 28px; height: 28px; margin-right: 8px;"/>
                        <label for="chkLocalSw" class="form-check-label" style="cursor: pointer;">LocalCoinSwap</label>
                    </div>
                    <div style="display: flex; align-items: center; min-width: 150px;">
                        <input id="chkBisqV1" type="checkbox" class="form-check-input me-2" checked/>
                        <img src="/Resources/img/Bisq.webp" style="width: 28px; height: 28px; margin-right: 8px;"/>
                        <label for="chkBisqV1" class="form-check-label" style="cursor: pointer;">Bisq v1</label>
                    </div>
                    <div style="display: flex; align-items: center; min-width: 150px;">
                        <input id="chkPeach" type="checkbox" class="form-check-input me-2" checked />
                        <img src="/Resources/img/PeachB2P.webp" style="width: 28px; height: 28px; margin-right: 8px;"/>
                        <label for="chkPeach" class="form-check-label" style="cursor: pointer;">Peach</label>
                    </div>
                </div>

                <br />
                <table><tr>
                    <td>
                        Percent to sale:&nbsp;
                        <input id="percentOnChain" type="number" max="100" value="100"/>
                    </td><td width="25"></td>                        
                    <td>
                        <label id="lblOnChainSale">@((int)walletConfig.OnChainFiatBalance)</label>&nbsp; @walletConfig.FiatCurrency
                    </td><td width="25"></td> 
                    <td><button id="btOnChainSearch" class="btn btn-primary" onclick="OnChainSearchClick()">Search</button></td>
                    </tr>
                </table>

                <br />
                <div id="container-B2pOnChain"></div>
            }
        </div>

        <div permission="@Policies.CanViewStoreSettings" id="tabLightning" style="display:none">
            <h4>Sell (Lightning)</h4>
            @if (walletConfig.OffChainEnabled)
            {
                <p><b>Balance</b>: @walletConfig.OffChainBalance BTC  ~ @DisplayFormatter.Currency(walletConfig.OffChainFiatBalance, walletConfig.FiatCurrency)</p>
            }
            else
            {
                <p>Lightning not configured</p>
            }

            @if (walletConfig.OffChainBalance == 0)
            {
                <p>No bitcoins available for sale</p>
            }
            else
            {
                <b>Select providers:</b><br />
                <script type="text/javascript">
                    const offChainFiatBalance = @walletConfig.OffChainFiatBalance.ToString(System.Globalization.CultureInfo.InvariantCulture);
                    document.addEventListener('DOMContentLoaded', () => {
                        document.getElementById('percentLightning').addEventListener('input', updateLightningSale);
                    });

                    function updateLightningSale() {
                        const percent = parseFloat(document.getElementById('percentLightning').value) || 0;
                        const amount = parseInt((percent * offChainFiatBalance) / 100);
                        document.getElementById('lblLightningToSale').textContent = amount;
                    }

                    function LightningSearchClick() {
                        var tbl = [];
                        if (document.querySelector('#chkLNp2p').checked) tbl.push(@((short)ProvidersEnum.LNp2pBot));
                        if (document.querySelector('#chkRbs').checked) tbl.push(@((short)ProvidersEnum.RoboSats));
                        if (document.querySelector('#chkMst').checked) tbl.push(@((short)ProvidersEnum.Mostro));
                        if (tbl.length == 0) return;

                        const data = {
                            Rate: @walletConfig.Rate, ApiKey: '@Model.Settings.ApiKey', CurrencyCode: '@walletConfig.FiatCurrency',
                            Amount: document.getElementById('lblLightningToSale').textContent, Providers: tbl
                        };
                        B2PCore.getPartial(data, "#container-B2pLightning", "#btLightningSearch", "GetPartialB2PResult");
                    }
                </script>

                <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; min-width: 150px;">
                        <input id="chkLNp2p" type="checkbox" class="form-check-input me-2" checked />
                        <img src="/Resources/img/LNp2pBot.webp" style="width: 28px; height: 28px; margin-right: 8px;"/>
                        <label for="chkLNp2p" class="form-check-label" style="cursor: pointer;">LNp2pBot</label>
                    </div>
                    <div style="display: flex; align-items: center; min-width: 150px;">
                        <input id="chkRbs" type="checkbox" class="form-check-input me-2" checked />
                        <img src="/Resources/img/RoboSats.webp" style="width: 28px; height: 28px; margin-right: 8px;"/>
                        <label for="chkRbs" class="form-check-label" style="cursor: pointer;">RoboSats</label>
                    </div>
                    <div style="display: flex; align-items: center; min-width: 150px;">
                        <input id="chkMst" type="checkbox" class="form-check-input me-2" checked />
                        <img src="/Resources/img/Mostro.webp" style="width: 28px; height: 28px; margin-right: 8px;"/>
                        <label for="chkMst" class="form-check-label" style="cursor: pointer;">Mostro</label>
                    </div>
                </div>
                <br />
                <table>
                    <tr>
                        <td>
                            Percent to sale:&nbsp;
                            <input id="percentLightning" type="number" max="100" value="100"/>
                        </td>
                        <td width="25" />
                        <td>
                            <label id="lblLightningToSale">@((int)walletConfig.OffChainFiatBalance)</label>&nbsp;@walletConfig.FiatCurrency
                        </td>
                        <td width="25" />
                        <td><button id="btLightningSearch" class="btn btn-primary" onclick="LightningSearchClick()">Search</button></td>
                    </tr>
                </table>

                <br />
                <div id="container-B2pLightning"></div>
            }
        </div>

        <div permission="@Policies.CanCreateNonApprovedPullPayments" id="tabSwaps" style="display:none" permission="@Policies.CanCreateNonApprovedPullPayments">
            <h4>Swaps (On Chain)</h4>
            @if (walletConfig.OnChainEnabled)
            {
                <p><b>Balance</b>: @walletConfig.OnChainBalance BTC  ~ @DisplayFormatter.Currency(walletConfig.OnChainFiatBalance, walletConfig.FiatCurrency)</p>
            }
            else
            {
                <p>On Chain wallet not configured</p>
            }

            @if (walletConfig.OnChainBalance == 0)
            {
                <p>No bitcoins available for swap</p>
            }
            else
            {
                <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 10px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; min-width: 150px;">
                        <table>
                            <tr><td>
                                <input value="ToSend" id="rdSend" name="rdFromTo" type="radio" checked="checked" class="form-check-input mt-0 me-2" onchange="B2PSwap.setSwapCurrency()" />
                                <label for="rdSend" class="form-check-label" style="cursor: pointer;">To Send</label>
                             </td></tr>
                             <tr><td>
                                <input value="ToReceive" id="rdReceive" name="rdFromTo" type="radio" class="form-check-input mt-0 me-2" onchange="B2PSwap.setSwapCurrency()" />
                                <label for="rdReceive" class="form-check-label" style="cursor: pointer;">To Receive</label>
                             </td></tr>
                        </table>
                    </div>
                    <div style="display: flex; align-items: center; min-width: 150px;">
                        <label for="swapAmount" class="form-input-label">Amount &nbsp;</label>
                        <input id="swapAmount" type="number" min="0" value="@((walletConfig.OnChainBalance * (decimal)0.95).ToString("F8"))" step="0.0001"/>
                        &nbsp;
                        <label id="lblCurrency" class="badge badge-settled">BTC</label>
                    </div>
                    <div id="divFiatSwap" style="display: flex; align-items: center; min-width: 150px;">
                        <label id="lblSwapFiat">@((int)(walletConfig.OnChainFiatBalance * (decimal)0.95))</label>&nbsp; @walletConfig.FiatCurrency
                    </div>
                    <div style="display: flex; align-items: center; min-width: 150px;">
                        <label for="lstSwapToCrypto" class="form-input-label">Crypto &nbsp;</label>
                        <select id="lstSwapToCrypto" class="form-select w-auto" onchange="B2PSwap.setSwapCurrency()">
                            @foreach (var group in SwapCryptos.AvailableCryptos.GroupBy(c => c.Value.Category).OrderBy(g => g.Key))
                            {
                                <optgroup label="@SwapCryptos.CategoryLabels[group.Key]">
                                    @foreach (var crypto in group.OrderBy(c => c.Value.Name))
                                    {
                                        <option value="@crypto.Key">@GetCryptoIcon(crypto.Key) @crypto.Value.Name</option>
                                    }
                                </optgroup>
                            }
                        </select>
                    </div>
                </div>
                <br /><br />
                <b>Select swap providers:</b>
                <br />
                <div style="margin-bottom: 10px;">
                    <input type="checkbox" class="btcpay-toggle me-3" id="chkNoKYC" onchange="B2PSwap.toggleKYCProviders()" />
                    <label class="form-check-label" for="chkNoKYC">No KYC Providers only</label>
                </div>
                <br />
                <div id="swapProvidersContainer" style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; margin-bottom: 15px;">
                    @foreach (var provider in SwapProviders.ActiveProviders)
                    {
                        var description = provider.GetDisplayName();
                        var imagePath = $"/Resources/img/{description}.webp";
                        var checkboxId = $"chkSwap{provider}";
                        var isKYC = SwapProviders.KYCProviders.Contains(provider);

                        <div id="provider@(provider)" class="swap-provider-item @(isKYC ? "kyc-provider" : "")" style="display: flex; align-items: center; min-width: 150px;" data-provider="@provider" data-is-kyc="@isKYC.ToString().ToLower()">
                            <input id="@checkboxId" type="checkbox" class="form-check-input me-2 swap-provider-checkbox" value="@((int)provider)" checked />
                            <img src="@imagePath" alt="@description" style="width: 28px; height: 28px; margin-right: 8px;"/>
                            <label for="@checkboxId" class="form-check-label" style="cursor: pointer;">@description</label>
                        </div>
                    }
                </div>
                <br/>

                <div style="display: flex; flex-direction: column; align-items: center; text-align: center; gap: 10px;">
                    <button id="btSwapSearch" class="btn btn-primary" onclick="B2PSwap.onSearchSwap('@Model.Settings.ApiKey','@walletConfig.FiatCurrency')">Search</button>
                    <i><small>Please check that there is no previous pending payout in BTCPay before placing a swap</small></i>
                </div>
                <br />
                <div id="container-B2pSwap"></div>
            }

            <form method="post" id="frmSwap" action="b2pcentral/CreateSwap">
                @Html.AntiForgeryToken()
                <input id="Provider" name="Provider" type="hidden" />
                <input id="ToCrypto" name="ToCrypto" type="hidden" />
                <input id="QuoteID" name="QuoteID" type="hidden" />
                <input id="FromAmount" name="FromAmount" type="hidden" />
                <input id="ToAmount" name="ToAmount" type="hidden" />
                <input id="ToAddress" name="ToAddress" type="hidden" />
                <input id="FromRefundAddress" name="FromRefundAddress" type="hidden" />
                <input id="IsFixed" name="IsFixed" type="hidden" />
                <input id="NotificationEmail" name="NotificationEmail" type="hidden" />
                <input id="ApiKey" name="ApiKey" type="hidden" value="@Model.Settings.ApiKey" />
            </form>

        </div>

        <div permission="@Policies.CanCreateNonApprovedPullPayments" id="tabListSwaps" style="display:none">
            @if(Model.Swaps.Any())
            {
                <h4>Swaps list</h4>
                <br />
                <div class="table-responsive">
                    <table class="table table-hover mass-action">
                        <thead class="mass-action-head">
                        <tr>
                            <th class="text-nowrap">Swap ID</th>
                            <th class="text-nowrap">Provider</th>
                            <th class="text-nowrap">Altcoin</th>
                            <th class="text-nowrap">Created At</th>
                            <th class="text-nowrap">Amount (BTC)</th>
                            <th class="text-nowrap">Amount (Alt)</th>
                            <th class="text-nowrap">Pull Payment</th>
                            <th>Status</th>
                        </tr>
                        </thead>
                        <tbody>
                            @foreach (var swap in Model.Swaps)
                            {
                                <tr>
                                    <td class="text-break align-middle invoiceId-col">
                                        <a href="@swap.ProviderUrl" target="_blank" class="invoice-details-link">@swap.SwapId</a>
                                    </td>
                                    <td class="align-center">
                                         <div class="badge badge-expired">
                                           @swap.Provider.GetDisplayName()
                                        </div>
                                    </td>
                                    <td class="align-center">
                                        <div class="badge badge-expired">
                                            @swap.ToCrypto @swap.ToNetwork
                                        </div>
                                    </td>
                                    <td>@swap.DateT</td>
                                    <td class="align-right">@swap.FromAmount.ToString("0.00000000")</td>
                                    <td class="align-right">@swap.ToAmount.ToString("0.00000000")</td>
                                    <td class="text-break align-middle invoiceId-col">
                                        <a asp-controller="UIPullPayment" asp-action="ViewPullPayment" asp-route-pullPaymentId="@swap.BTCPayPullPaymentId" class="text-break">@swap.BTCPayPullPaymentId</a>
                                    </td>
                                    <td>
                                        <a href="@swap.FollowUrl" target="_blank">View JSON</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p>No swaps found for this store.</p>
            }
        </div>
    }
</div>

@section PageFootContent {
    <script src="/Resources/js/b2p-swap.js" asp-append-version="true" asp-add-nonce="true" id="b2p-swap-script"></script>
    <script asp-add-nonce="true">
        (function() {
            const scriptElement = document.getElementById('b2p-swap-script');

            function runInit() {
                window.B2PSwap.initSwap(@walletConfig.OnChainFiatBalance.ToString(System.Globalization.CultureInfo.InvariantCulture),
                                        @walletConfig.OnChainBalance.ToString(System.Globalization.CultureInfo.InvariantCulture));
            }

            if (window.B2PSwap) {
                runInit();
            } else {
                scriptElement.addEventListener('load', runInit);
            }

            $(document).ajaxComplete(function(event, xhr, settings) {
                if (settings.url && settings.url.includes('GetPartialB2PSwapResult')) {
                    const swapData = $('#b2p-swap-data');
                    const data = JSON.parse(swapData.text());
                    window.B2PSwap.init(data.swaps, data.rateReq);
                }
            });
        })();
    </script>
}